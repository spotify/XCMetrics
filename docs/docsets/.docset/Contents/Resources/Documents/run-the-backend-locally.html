<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Run the Backend Locally  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
	<meta name="viewport" content="width=device-width, viewport-fit=cover, initial-scale=1.0" />
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Run the Backend Locally  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p>
          <a href="index.html"> Docs</a>
          <span class="no-mobile"> (73% documented)</span>
        </p>
    
        <p class="header-right">
          <a href="https://github.com/spotify/XCMetrics">
            <img src="img/gh.png"/>
            <span class="no-mobile">View on GitHub</span>
          </a>
        </p>
    
      </div>
    </header>
    <div id="breadcrumbs-container">
      <div class="content-wrapper">
        <p id="breadcrumbs">
          <span class="no-mobile">
            <a href="index.html"> Reference</a>
            <img id="carat" src="img/carat.png" />
          </span>
          Run the Backend Locally  Reference
        </p>
      </div>
    </div>
    <div class="wrapper">
      <div class="article-wrapper">
        <article class="main-content">
          <section>
            <section class="section">
              
              <h1 id='running-the-backend-locally' class='heading'>Running the backend locally</h1>

<p>It&rsquo;s useful to run the backend locally to test that you can ingest data to it before deploying your changes. This guide will walk you through the necessary steps.</p>

<p>The Backend is built using the <a href="https://vapor.codes">Vapor 4.0 framework</a>. We advise to read the <a href="https://docs.vapor.codes/4.0/">official documentation</a> if you plan to contribute to it. Another good resource for learning it, is <a href="https://www.raywenderlich.com/11555468-getting-started-with-server-side-swift-with-vapor-4">this tutorial</a></p>
<h2 id='1-running-it-from-our-docker-image' class='heading'>1. Running it from our Docker Image</h2>

<p>The easiest way to run it is to use our prebuilt <a href="https://hub.docker.com/r/spotify/xcmetrics">Docker Image</a>. Because it requires a Redis and a Postgres instance, we provide a Docker compose file that configures them for you. The file is called <code>docker-compose-local.yml</code>.</p>

<ol>
<li>If you haven&rsquo;t, install <a href="https://docs.docker.com/docker-for-mac/">Docker for Mac</a>.</li>
<li>From the command line, run this command:</li>
</ol>
<pre class="highlight plaintext"><code>docker-compose -f docker-compose-local.yml up
</code></pre>

<p>The command will start the Postgres database, Redis and the XCMetrics backend. 
The XCMetrics backend should be available in the port <strong>8080</strong>.</p>

<p>To check that it works you can simply run</p>
<pre class="highlight plaintext"><code>curl -I http://localhost:8080/hello
</code></pre>
<h2 id='2-running-it-from-xcode' class='heading'>2. Running it from Xcode</h2>

<p>The Backend needs Redis and Postgresql to run. This repo contains a <code>docker-compose.yml</code> file that you can use to start them. From the command line run
<code>docker-compose up -d</code></p>

<p><strong>Note:</strong> Remember to stop the docker instances when you&rsquo;re done using the Backend locally with <code>docker-compose stop</code></p>
<h3 id='2-1-database-migrations' class='heading'>2.1 Database migrations</h3>

<p>The migrations will create the tables that the project uses in the Database. You only need to run them the first time you&rsquo;re going to start the backend or if a table changed since the last time you ran it. That information can be found in the Changelog.</p>

<p>From the command line</p>
<pre class="highlight plaintext"><code>swift run XCMetricsBackend migrate
</code></pre>

<p>Or from Xcode, select the <strong>XCMetricsBackend</strong> schema and setup <code>migrate</code> as an Argument:</p>

<p><img src="img/backend-migrate.png" alt="Xcode Schema argument"></p>

<p><strong>Note:</strong> You will get a prompt to confirm the migrations. Just press <code>y</code>.</p>
<h3 id='2-2-start-the-backend' class='heading'>2.2 Start the backend</h3>

<p>From the command line:</p>
<pre class="highlight plaintext"><code>swift run XCMetricsBackend
</code></pre>

<p>Or from Xcode: remove the <code>migrate</code> argument and run the <strong>XCMetricsBackend</strong> schema</p>
<h3 id='2-3-verify-that-is-running' class='heading'>2.3 Verify that is running</h3>

<p>The backend will start at port 8080. </p>

<p>Run </p>

<p><code>curl -I http://localhost:8080/hello</code></p>
<h2 id='3-insert-xcode-build-log-data-using-the-xcmetrics-client' class='heading'>3. Insert Xcode build log data using the XCMetrics Client</h2>

<p>Configure a Xcode project to use <code><a href="Structs/XCMetrics.html">XCMetrics</a></code> as described in our <a href="https://github.com/spotify/XCMetrics/blob/main/docs/Getting%20Started.md">Getting Started guide</a>. Double check that in the Post-build action you pass localhost to the <code>--serviceURL</code> parameter: <code>--serviceURL http://localhost:8080/v1/metrics</code>.</p>

<p>Once you send data to the backend by building the Xcode project where you configured <code><a href="Structs/XCMetrics.html">XCMetrics</a></code>, verify that it was inserted by inspecting the database. You can use any Postgres client like <a href="https://eggerapps.at/postico/">Postico</a>. The Postgres instance is running in localhost, port 5432. Check the <code>docker-compose.yml</code> file for the database name and the default user and password. The main table is called <code>builds</code>. You will see the build data in that table.</p>

<blockquote>
<p>Note: make sure to change the authentication values when deploying your service to production not to use the default values.</p>
</blockquote>
<h2 id='common-pitfalls' class='heading'>Common pitfalls</h2>
<h3 id='address-already-in-use' class='heading'>Address already in use</h3>

<p><code>[ ERROR ] bind(descriptor:ptr:bytes:): Address already in use (errno: 48)</code></p>

<p>Sometimes, Xcode fails to stop the Backend properly. And the next time you try to run it you get that error. You will need to kill it manually:</p>

<p>Run <code>ps -ax | grep -i XCMetricsBackend</code>, look for a process that is run from DerivedData, like this:</p>

<p><code>86981 ??         0:02.85 /Users/user/Library/Developer/Xcode/DerivedData/XCMetrics-aqdxosbxjtygdlhkquzojjjgxwce/Build/Products/Debug/XCMetricsBackend</code></p>

<p>Kill the process using its PID: <code>kill -9 86981</code></p>
<h3 id='connection-reset-error' class='heading'>Connection reset error</h3>

<p>When you start the backend you get errors like <code>[ ERROR ] Job run failed: connection reset (error set): Connection refused (errno: 61)</code> that means that docker compose did not start correctly.</p>

<p>To check the reason:</p>

<ol>
<li>Stop the instances with <code>docker-compose stop</code>.</li>
<li>Run <code>docker-compose up</code> (No <code>- d</code>) to check the output of the command.</li>
</ol>

<p>Things to verify: Redis will try to start in Port <code>6379</code> and Postgres in <code>5432</code>. If you are already using those ports in other processes, change them in the <code>docker-compose.yml</code>. In this example we&rsquo;re changing the Redis port to <strong>6500</strong>. In docker compose, the left port is the port that will be used in your host, the right port is the port of the docker instance that will be bound to the left port.</p>
<pre class="highlight plaintext"><code>    ports:
       - "6500:6379"
</code></pre>

            </section>
          </section>
        </article>
      </div>
      <div class="nav-wrapper">
        <nav class="nav-bottom">
          <ul class="nav-groups">
            <li class="nav-group-name">
              <a href="HTTP%20Endpoints.html">HTTP Endpoints</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="Structs/BuildController.html">BuildController</a>
                </li>
                <li class="nav-group-task">
                  <a href="Structs/JobLogController.html">JobLogController</a>
                </li>
                <li class="nav-group-task">
                  <a href="Structs/UploadMetricsController.html">UploadMetricsController</a>
                </li>
              </ul>
            </li>
            <li class="nav-group-name">
              <a href="Other%20Guides.html">Other Guides</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="getting-started.html">Getting Started</a>
                </li>
                <li class="nav-group-task">
                  <a href="how-to-deploy-backend.html">How to Deploy Backend</a>
                </li>
                <li class="nav-group-task">
                  <a href="log-management-deep-dive.html">Log Management Deep Dive</a>
                </li>
                <li class="nav-group-task">
                  <a href="run-the-backend-locally.html">Run the Backend Locally</a>
                </li>
              </ul>
            </li>
            <li class="nav-group-name">
              <a href="Other%20Classes.html">Other Classes</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="Classes/Build.html">Build</a>
                </li>
                <li class="nav-group-task">
                  <a href="Classes/BuildError.html">BuildError</a>
                </li>
                <li class="nav-group-task">
                  <a href="Classes/BuildHost.html">BuildHost</a>
                </li>
                <li class="nav-group-task">
                  <a href="Classes/BuildMetadata.html">BuildMetadata</a>
                </li>
                <li class="nav-group-task">
                  <a href="Classes/BuildWarning.html">BuildWarning</a>
                </li>
                <li class="nav-group-task">
                  <a href="Classes/JobLogEntry.html">JobLogEntry</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Classes.html#/s:15XCMetricsClient27MetricsPublisherServiceHTTPC">MetricsPublisherServiceHTTP</a>
                </li>
                <li class="nav-group-task">
                  <a href="Classes/XCMetricsConfiguration.html">XCMetricsConfiguration</a>
                </li>
              </ul>
            </li>
            <li class="nav-group-name">
              <a href="Other%20Extensions.html">Other Extensions</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="Extensions/BuildHost.html">BuildHost</a>
                </li>
                <li class="nav-group-task">
                  <a href="Extensions/BuildMetadata.html">BuildMetadata</a>
                </li>
                <li class="nav-group-task">
                  <a href="Extensions/String.html">String</a>
                </li>
                <li class="nav-group-task">
                  <a href="Extensions/XcodeVersion.html">XcodeVersion</a>
                </li>
              </ul>
            </li>
            <li class="nav-group-name">
              <a href="Other%20Functions.html">Other Functions</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="Other%20Functions.html#/s:19XCMetricsBackendLib9configureyy5Vapor11ApplicationCKF">configure(_:)</a>
                </li>
              </ul>
            </li>
            <li class="nav-group-name">
              <a href="Other%20Structs.html">Other Structures</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="Other%20Structs.html#/s:19XCMetricsBackendLib13BuildResponseV">BuildResponse</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Structs.html#/s:19XCMetricsBackendLib15ChartTimeSeriesV">ChartTimeSeries</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Structs.html#/s:19XCMetricsBackendLib12JobDashboardV">JobDashboard</a>
                </li>
                <li class="nav-group-task">
                  <a href="Structs/MetricsUploadRequest.html">MetricsUploadRequest</a>
                </li>
                <li class="nav-group-task">
                  <a href="Structs/XCMetrics.html">XCMetrics</a>
                </li>
                <li class="nav-group-task">
                  <a href="Structs/XCMetricsPlugin.html">XCMetricsPlugin</a>
                </li>
              </ul>
            </li>
            <li class="nav-group-name">
              <a href="Other%20Typealiases.html">Other Type Aliases</a>
              <ul class="nav-group-tasks">
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient5Builda">Build</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient9BuildHosta">BuildHost</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient13BuildMetadataa">BuildMetadata</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient10ErrorBuilda">ErrorBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient13FunctionBuilda">FunctionBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient9NoteBuilda">NoteBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient9StepBuilda">StepBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient19SwiftTypeCheckBuilda">SwiftTypeCheckBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient11TargetBuilda">TargetBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient25UploadBuildMetricsRequesta">UploadBuildMetricsRequest</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient12WarningBuilda">WarningBuild</a>
                </li>
                <li class="nav-group-task">
                  <a href="Other%20Typealiases.html#/s:15XCMetricsClient12XcodeVersiona">XcodeVersion</a>
                </li>
              </ul>
            </li>
          </ul>
        </nav>
      </div>
      <div class="footer-wrapper">
        <section id="footer">
          <p>&copy; 2021 <a class="link" href="" target="_blank" rel="external">Spotify</a>. All rights reserved. (Last updated: 2021-01-26)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.6</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </div>
    </div>
  </body>
</div>
</html>
